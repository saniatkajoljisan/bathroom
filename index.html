<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bathroom Clean Schedule - Live System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f7; margin: 0; }
        html { scroll-behavior: smooth; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        table { border-spacing: 0; width: 100%; border-radius: 20px; }
        th, td { border-bottom: 1px solid #f0f0f0; }
        .box-shadow-custom { box-shadow: 0 20px 50px rgba(0,0,0,0.05); }
        .sticky-header {
            position: sticky !important; top: 0 !important; z-index: 999 !important;
            background: linear-gradient(135deg,rgba(38, 135, 231, 0.8),  rgba(207, 228, 241, 0.6)   ) !important;
            backdrop-filter: blur(2px) saturate(180%) !important; -webkit-backdrop-filter: blur(2px) saturate(180%) !important;
            border-bottom: 1px solid rgba(255,255,255,0.25);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), 0 8px 30px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="pb-10">

<div class="max-w-4xl mx-auto px-4 md:px-0 pt-4 md:pt-10 space-y-10">
    <div class="bg-white box-shadow-custom rounded-[32px] border border-white relative">
        <div class="sticky-header p-8 text-center text-white relative">
            <h1 class="text-2xl md:text-4xl font-black tracking-tight drop-shadow-md">Bathroom Clean Schedule</h1>
            <div id="live-indicator" class="text-[10px] opacity-90 font-bold mt-1 tracking-widest uppercase">Connecting...</div>
        </div>

        <div class="overflow-x-auto overflow-y-visible">
            <table class="text-left">
                <thead class="bg-gray-50/50">
                    <tr class="text-gray-500 text-[11px] uppercase font-black tracking-widest">
                        <th class="p-6 text-center w-20">SL</th>
                        <th class="p-6">Member Name</th>
                        <th class="p-6">Date (Friday)</th>
                        <th class="p-6 text-center w-32">Status</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="bg-white/60 box-shadow-custom rounded-[32px] overflow-hidden border border-white/50">
        <div class="bg-gray-200/80 p-4 text-center backdrop-blur-sm">
            <h2 class="text-sm font-black text-gray-600 uppercase tracking-widest">Previous History (Past 8 Weeks)</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="text-left opacity-70">
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>
</div>

<p class="text-center text-gray-400 text-[10px] mt-12 mb-8 tracking-[0.3em] font-bold uppercase">Dream City Mess - Skjisan</p>

<div id="selectionModal" class="modal">
    <div class="bg-white p-8 rounded-[32px] shadow-2xl w-80 text-center">
        <h3 class="text-lg font-black text-gray-800 mb-2 uppercase italic">Select Status</h3>
        <p class="text-gray-400 text-[10px] mb-6 font-bold uppercase tracking-wider">Warning: Cannot be edited later</p>
        <div class="flex justify-between gap-4">
            <button onclick="confirmAction('✔')" class="flex-1 bg-green-50 text-green-600 border-2 border-green-500 font-black py-4 rounded-2xl text-2xl">✔</button>
            <button onclick="confirmAction('✘')" class="flex-1 bg-red-50 text-red-600 border-2 border-red-500 font-black py-4 rounded-2xl text-2xl">✘</button>
        </div>
        <button onclick="closeModal()" class="mt-6 text-gray-400 text-[10px] font-black uppercase tracking-widest">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAlXlbUD2nlMsH7VtCiS9NjkMzpcDl38iE",
        authDomain: "bathroom-clean-c35e0.firebaseapp.com",
        databaseURL: "https://bathroom-clean-c35e0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bathroom-clean-c35e0",
        storageBucket: "bathroom-clean-c35e0.firebasestorage.app",
        messagingSenderId: "1060489726116",
        appId: "1:1060489726116:web:46c68029ecd2b216463e31"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'clean_system');

    let appData = {};
    let memberNames = ["Member 1", "Member 2", "Member 3", "Member 4", "Member 5", "Member 6"];
    let activeCellId = null;

    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            appData = data.status || {};
            memberNames = data.names || memberNames;
        }
        document.getElementById('live-indicator').innerHTML = `
            <span class="flex items-center justify-center gap-1.5">
                <span class="text-green-400 text-lg leading-none">●</span> 
                <span>Live Sync Active</span>
            </span>`;
        renderUI();
    });

    function renderUI() {
        const now = new Date();
        let currentFriday = getFirstFridayOfMonth(now.getFullYear(), now.getMonth());
        
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        let date = new Date(currentFriday);

        for (let i = 0; i < 6; i++) {
            const dateKey = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
            const dateString = date.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'short', year:'numeric' });
            const status = appData[dateKey] || '';
            const isLocked = status !== '';

            const row = `
                <tr class="hover:bg-indigo-50/30 transition-colors">
                    <td class="p-6 text-center text-gray-300 font-black text-sm">${i+1}</td>
                    <td class="p-6">
                        <input type="text" value="${memberNames[i]||''}" 
                            onchange="window.saveName(${i}, this.value)" 
                            ${isLocked ? 'readonly' : ''} 
                            class="w-full bg-transparent font-bold ${isLocked ? 'text-gray-400 cursor-not-allowed' : 'text-gray-600'} outline-none">
                    </td>
                    <td class="p-6 text-gray-400 font-bold text-sm">${dateString}</td>
                    <td class="p-6 text-center">
                        <div onclick="${!isLocked ? `window.openModal('${dateKey}')` : ''}" 
                            class="w-12 h-12 mx-auto flex items-center justify-center rounded-2xl border-2 font-black text-xl 
                            ${isLocked ? (status==='✔'?'text-green-600 bg-green-50 border-transparent':'text-red-600 bg-red-50 border-transparent') 
                            : 'border-dashed border-gray-200 text-gray-300 hover:border-indigo-400 hover:text-indigo-400 cursor-pointer'}">
                            ${status}
                        </div>
                    </td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
            date.setDate(date.getDate() + 7);
        }

        const historyBody = document.getElementById('history-body');
        historyBody.innerHTML = '';
        let histDate = new Date(currentFriday);
        histDate.setDate(histDate.getDate() - 7);
        let count = 0;

        for (let i = 0; i < 20; i++) {
            const dateKey = `${histDate.getFullYear()}-${histDate.getMonth()+1}-${histDate.getDate()}`;
            const s = appData[dateKey] || '';
            if (s && count < 8) {
                historyBody.insertAdjacentHTML('beforeend', `
                    <tr class="bg-white/30">
                        <td class="p-4 text-xs font-bold text-gray-400">${histDate.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })}</td>
                        <td class="p-4 text-sm font-bold text-gray-600">Friday Duty Log</td>
                        <td class="p-4 text-center font-black text-lg ${s==='✔'?'text-green-400':'text-red-400'}">${s}</td>
                    </tr>`);
                count++;
            }
            histDate.setDate(histDate.getDate() - 7);
        }
        if(!count) historyBody.innerHTML = '<tr><td colspan="3" class="p-10 text-center text-gray-400">No data found.</td></tr>';
    }

    function getFirstFridayOfMonth(year, month) {
        let d = new Date(year, month, 1);
        while (d.getDay() !== 5) d.setDate(d.getDate()+1);
        return d;
    }

    window.saveName = (index, val) => {
        memberNames[index] = val;
        update(dbRef, { names: memberNames });
    };

    window.openModal = (id) => {
        activeCellId = id;
        document.getElementById('selectionModal').classList.add('active');
    };

    window.closeModal = () => document.getElementById('selectionModal').classList.remove('active');

    window.confirmAction = (status) => {
        if (activeCellId) {
            update(ref(db, 'clean_system/status'), { [activeCellId]: status });
            window.closeModal();
        }
    };
</script>
</body>
</html>
