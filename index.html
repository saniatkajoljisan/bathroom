<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bathroom Clean Schedule - Live System</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/saniatkajoljisan/bathroom@latest/flip.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">

<style>
body { font-family:'Inter',sans-serif; background:#f3f4f7; margin:0; }
html { scroll-behavior:smooth; }

.modal{
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  align-items:center; justify-content:center;
  z-index:100; backdrop-filter:blur(4px);
}
.modal.active{ display:flex; }

table{ border-spacing:0; width:100%; border-radius:20px; }
th,td{ border-bottom:1px solid #f0f0f0; }

.box-shadow-custom{ box-shadow:0 20px 50px rgba(0,0,0,.05); }

.sticky-header{
  position:sticky; top:0; z-index:999;
  background:linear-gradient(135deg,rgba(38,135,231,.85),rgba(207,228,241,.65));
  backdrop-filter:blur(1px) saturate(180%);
  border-bottom:1px solid rgba(255,255,255,.25);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.35),0 8px 30px rgba(0,0,0,.15);
}
body.dark {
    background: #0f172a;
    color: #e2e8f0;
}
body.dark .bg-white { background: #1e293b !important; border-color: #334155 !important; }
body.dark .bg-blue-50\/40 { background: rgba(30, 41, 59, 0.6) !important; }
body.dark .text-gray-600 { color: #94a3b8 !important; }
body.dark .text-gray-400 { color: #64748b !important; }
body.dark .text-gray-800 { color: #64748b !important; }
body.dark .text-gray-500 { color: #94a3b8 !important; }
body.dark .text-gray-300 { color: #cbd5e1 !important; }
body.dark th { color: #94a3b8 !important; }
body.dark .bg-gray-50\/50 { background: rgba(30, 41, 59, 0.3) !important; }
body.dark .hover\:bg-indigo-50\/30:hover { background: rgba(99, 102, 241, 0.1)!important; }
body.dark .bg-blue-50\/10 { background: rgba(59, 130, 246, 0.1) !important; }
body.dark .bg-green-50 { background: rgba(34, 197, 94, 0.2) !important; }
body.dark .bg-red-50 { background: rgba(248, 113, 113, 0.2) !important; }
body.dark .bg-blue-100 { background: rgba(96, 165, 250, 0.3) !important; }
body.dark .bg-orange-100 { background: rgba(251, 191, 36, 0.2) !important; }
body.dark input::placeholder { color: #64748b !important; }
body.dark input[readonly] { color: #94a3b8 !important; }
body.dark th, body.dark td { border-bottom-color: #334155 !important; }

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0.3; }
}

#live-indicator {
  animation: blink 1.5s infinite;
}
</style>
</head>

<body class="pb-10">
<script>
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
    }
</script>

<div class="max-w-4xl mx-auto px-4 md:px-0 pt-4 md:pt-10 space-y-6">

<div class="bg-white box-shadow-custom rounded-[32px] border border-white">

<div class="sticky-header p-5 text-center text-white">
<h1 class="text-[16px] md:text-3xl font-black uppercase tracking-[0.15em] md:tracking-[0.25em] drop-shadow-md text-center py-4">Bathroom Clean Schedule</h1>
<button id="darkToggle" class="absolute right-1 top-3/4 -translate-y-1/2 p-2 rounded-full bg-white/20 hover:bg-white/30 transition-all">
    <span class="sun-icon block">‚òÄÔ∏è</span>
    <span class="moon-icon block hidden">üåô</span>
</button>
<div id="live-indicator" class="text-[10px] opacity-90 font-bold mt-1 tracking-widest uppercase">
Connecting...
</div>
</div>

<div class="px-6 py-5 bg-blue-50/40 backdrop-blur-sm space-y-3">

<div>
<div class="flex justify-between text-[10px] font-black tracking-widest uppercase text-gray-600 mb-1">
<span>Total Status Ratio</span>
<span id="statusPercent">0%</span>
</div>
<div class="w-full h-2 rounded-full bg-blue-100 overflow-hidden">
<div id="statusBar" class="h-full w-0 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-500"></div>
</div>
</div>

<div>
<div class="flex justify-between text-[10px] font-black tracking-widest uppercase text-gray-600 mb-1">
<span>Total Approval Ratio</span>
<span id="approvalPercent">0%</span>
</div>
<div class="w-full h-2 rounded-full bg-blue-100 overflow-hidden">
<div id="approvalBar" class="h-full w-0 rounded-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-500"></div>
</div>
</div>

<div id="waitingMsg"
class="text-center text-[10px] font-bold tracking-widest uppercase text-gray-400 hidden">
‚è≥ Waiting for admin final approval‚Ä¶
</div>
<div class="notice-box mb-2">
 <marquee id="monthMarquee" style="color: rgba(70, 153, 236, 0.85); padding: 4px; border-radius: 6px; border: 1px solid #699ef5; margin-top: 5px; font-size: 11px; font-weight: 650; letter-spacing: 1.5px;" behavior="scroll">After cleaning the bathroom, enter your name and update the status to (‚úîÔ∏è).</marquee>
</div>

</div>

<div class="overflow-x-auto">
<table class="text-left">
<thead class="bg-gray-50/50">
<tr class="text-gray-500 text-[11px] uppercase font-black tracking-widest">
<th class="p-6 text-center w-20">SL</th>
<th class="p-6 min-w-[163px]">Member Name</th>
<th class="p-6">Date (Friday)</th>
<th class="p-6 text-center w-32">Status</th>
<th class="p-6 text-center w-32 bg-blue-50/30">Final Approval</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>
</div>

</div>
<div style="background-color: rgba(30, 144, 255, 0.9); color: white; padding: 4px 10px; border-radius: 4px; text-align: center; text-transform: uppercase; font-size: 10px; font-weight: 800; letter-spacing: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">üïí Upcoming Friday In</div>
<div class="text-center">
      <div id="flipdownTimer" class="flipdown d-inline-block"></div>
  </div>
</div>

<p id="adminToggle"
onclick="window.toggleAdmin()"
class="text-center text-gray-400 text-[10px] mt-12 mb-8 tracking-[0.3em] font-bold uppercase cursor-pointer">
Dream City Mess - Skjisan
</p>

<div id="selectionModal" class="modal">
<div class="bg-white p-8 rounded-[32px] shadow-2xl w-80 text-center">
<h3 class="text-lg font-black text-gray-800 mb-2 uppercase italic">Select Status</h3>
<p class="text-gray-400 text-[10px] mb-6 font-bold uppercase tracking-wider">
Warning: You Cannot Change It later
</p>

<div class="flex gap-3">
<button onclick="confirmAction('‚úî')" class="flex-1 bg-green-50 text-green-600 border-2 border-green-500 font-black py-4 rounded-2xl text-2xl">‚úî</button>
<button onclick="confirmAction('‚úò')" class="flex-1 bg-red-50 text-red-600 border-2 border-red-500 font-black py-4 rounded-2xl text-2xl">‚úò</button>
<button id="resetBtn" onclick="confirmAction('')" class="flex-1 bg-gray-50 text-gray-500 border-2 border-gray-300 font-black py-4 rounded-2xl text-xl hidden">‚Ü∫</button>
</div>

<button onclick="closeModal()" class="mt-6 text-gray-400 text-[10px] font-black uppercase tracking-widest">
Close
</button>
</div>
</div>

<div id="cycleModal" class="modal">
<div class="bg-white p-10 rounded-[32px] shadow-2xl w-96 text-center">
<div class="text-green-500 text-4xl mb-4 font-black">‚úî</div>
<h3 class="text-xl font-black text-gray-800 mb-2 uppercase">
Cycle Completed
</h3>
<p id="nextCycleText" class="text-gray-500 text-sm font-bold mb-6"></p>
<button onclick="closeCycleModal()" class="px-8 py-3 rounded-2xl bg-blue-600 text-white font-black tracking-widest text-sm">
OK
</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
apiKey:"AIzaSyAlXlbUD2nlMsH7VtCiS9NjkMzpcDl38iE",
authDomain:"bathroom-clean-c35e0.firebaseapp.com",
databaseURL:"https://bathroom-clean-c35e0-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"bathroom-clean-c35e0",
storageBucket:"bathroom-clean-c35e0.firebasestorage.app",
messagingSenderId:"1060489726116",
appId:"1:1060489726116:web:46c68029ecd2b216463e31"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const dbRef=ref(db,'clean_system');

let appData={}, memberNames=["Name","Name","Name","Name","Name","Name"];
let activeCellId=null,isAdmin=false,startFriday=null;

const getNextFriday=d=>{
d=new Date(d);
d.setDate(d.getDate()+((5-d.getDay()+7)%7||7));
return d;
};

onValue(dbRef,async snap=>{
const data=snap.val()||{};
appData=data.status||{};
memberNames=data.names||memberNames;

if(!data.startFriday){
startFriday=getNextFriday(new Date());
await update(dbRef,{startFriday:startFriday.toISOString()});
}else startFriday=new Date(data.startFriday);

document.getElementById('live-indicator').innerHTML=
'<span class="flex items-center justify-center gap-1.5"><span class="text-green-400 text-lg">‚óè</span>Live Sync Active</span>';

renderUI();
});

function renderUI(){
    const tbody=document.getElementById('table-body');
    tbody.innerHTML='';
    let d=new Date(startFriday), sc=0, ac=0;
    
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;

    for(let i=0;i<6;i++){
        const k=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        const s=appData[k]||'', a=appData[k+'_appr']||'';
        if(s) sc++; if(a) ac++;
      
        const isToday = (k === todayStr);

        tbody.insertAdjacentHTML('beforeend',`
        <tr class="${isToday ? 'bg-blue-50/50 shadow-sm' : 'hover:bg-indigo-50/30'} transition-all duration-300">
            <td class="p-6 text-center ${isToday ? 'text-blue-600' : 'text-gray-300'} font-black">
                ${isToday ? '‚òÖ' : i+1}
            </td>
            <td class="p-6">
                <input placeholder="${memberNames[i] || 'Name'}" 
                       value="${memberNames[i] && memberNames[i] !== 'Name' ? memberNames[i] : ''}" 
                       onchange="saveName(${i},this.value || 'Name')"
                       ${s&&!isAdmin?'readonly':''}
                       class="w-full bg-transparent font-bold ${isToday ? 'text-blue-700' : (s&&!isAdmin?'text-gray-400':'text-gray-500')} outline-none placeholder-gray-300">
                ${isToday ? '<span class="text-[9px] font-black text-blue-600 uppercase tracking-widest">‚óè Today\'s Turn</span>' : ''}
            </td>
            <td class="p-6 ${isToday ? 'text-blue-600' : 'text-gray-400'} font-bold text-sm">
                ${d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}
            </td>
            <td class="p-6 text-center">
                <div onclick="${(!s||isAdmin)?`openModal('${k}', event)`:''}"
                class="w-12 h-12 mx-auto flex items-center justify-center rounded-2xl border-2 font-black text-xl
                ${s?s==='‚úî'?'text-green-600 bg-green-50 border-transparent':'text-red-600 bg-red-50 border-transparent'
                :isToday ? 'border-blue-400 border-solid bg-blue-100/50 text-blue-400 cursor-pointer animate-pulse' : 'border-dashed border-gray-200 text-gray-300 cursor-pointer'}">${s}</div>
            </td>
            <td class="p-6 text-center ${isToday ? 'bg-blue-100/20' : 'bg-blue-50/10'}">
                <div onclick="${isAdmin?`openModal('${k}_appr', event)`:''}"
                class="w-12 h-12 mx-auto flex items-center justify-center rounded-2xl border-2 font-black text-xl
                ${a?a==='‚úî'?'text-blue-600 bg-blue-100 border-transparent':'text-orange-600 bg-orange-100 border-transparent'
                :isAdmin?'border-blue-300 text-blue-300 cursor-pointer':'text-transparent'}">${a}</div>
            </td>
        </tr>`);
        d.setDate(d.getDate()+7);
    }
const sp=Math.round((sc/6)*100);
const ap=Math.round((ac/6)*100);

document.getElementById('statusBar').style.width=sp+'%';
document.getElementById('approvalBar').style.width=ap+'%';
document.getElementById('statusPercent').innerText=sp+'%';
document.getElementById('approvalPercent').innerText=ap+'%';

const waitMsg=document.getElementById('waitingMsg');
if(sc===6 && ac<6) waitMsg.classList.remove('hidden');
else waitMsg.classList.add('hidden');

document.getElementById('adminToggle').innerText = isAdmin ? 'ADMIN MODE ¬∑ LOGOUT' : 'Dream City Mess - Skjisan';

// Update Icons based on current state
const isDark = document.body.classList.contains('dark');
const sunIcon = document.querySelector('.sun-icon');
const moonIcon = document.querySelector('.moon-icon');
if(sunIcon && moonIcon) {
    sunIcon.classList.toggle('hidden', isDark);
    moonIcon.classList.toggle('hidden', !isDark);
}
}

function cycleComplete(){
let d=new Date(startFriday);
for(let i=0;i<6;i++){
const k=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
if(!appData[k]||!appData[k+'_appr']) return false;
d.setDate(d.getDate()+7);
}
return true;
}

window.toggleAdmin=()=>{
if(!isAdmin){
const p=prompt("Admin Password:");
if(p==="sk77"){
isAdmin=true;
alert("Admin Mode Active");
renderUI();
}
}else{
isAdmin=false;
renderUI();
}
};

window.confirmAction=async status=>{
if(!activeCellId) return;
await update(ref(db,'clean_system/status'),{[activeCellId]:status});

if(isAdmin && activeCellId.endsWith('_appr') && cycleComplete()){
const next=new Date(startFriday);
next.setDate(next.getDate()+7);
document.getElementById('nextCycleText').innerText=
`Next cycle starts from: ${next.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}`;
document.getElementById('cycleModal').classList.add('active');
await update(dbRef,{startFriday:next.toISOString(),status:{}});
}
closeModal();
};

window.openModal=(id, e)=>{
if (!id.endsWith('_appr')) {
    const clickedRow = e.currentTarget.closest('tr');
    const inputField = clickedRow.querySelector('input');
    const nameValue = inputField.value.trim();

    if (!nameValue || nameValue === "Name") {
        alert("‚ö†Ô∏è Please enter your name first!");
        return;
    }
}
activeCellId=id;
document.getElementById('selectionModal').classList.add('active');
document.getElementById('resetBtn').classList.toggle('hidden',!isAdmin);
};

window.closeModal=()=>{
document.getElementById('selectionModal').classList.remove('active');
activeCellId=null;
};

window.closeCycleModal=()=>document.getElementById('cycleModal').classList.remove('active');

window.saveName=(i,v)=>{
    memberNames[i]=v.trim() === '' ? 'Name' : v.trim();
    update(dbRef,{names:memberNames});
};

document.getElementById('darkToggle').addEventListener('click', function() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    renderUI(); // Re-render to update icons and styles
});
</script>
<script src="https://cdn.jsdelivr.net/gh/saniatkajoljisan/bathroom/flip.js"></script>

</body>
</html>
